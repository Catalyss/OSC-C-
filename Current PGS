using System.Net.WebSockets;
using System.Text;
using Microsoft.AspNetCore;
using Newtonsoft.Json.Linq;
using System.Net.Sockets;
using CoreOSC.IO;
using CoreOSC;
using Newtonsoft.Json;
using System.Text.RegularExpressions;
using System.Diagnostics;
using System.Security.Cryptography.X509Certificates;
using System.Security.Cryptography;
using System.Net;
using Microsoft.AspNetCore.Hosting;
using System.Net.Http.Headers;
using static LogProcessor;
using System.Xml;

namespace OscWebServer
{
    class Program
    {
        #region Config & State Variables
        private static int webPort = 80;
        private static int oscPortOut = 9002;
        private static int oscPortIn = 9003;
        private static int saveCount = 5;
        private static string CurrentID = "none";
        private static IWebHost webHost;
        private static string PUBIP = "localhost";
        private static string DNS = "";
        private static string httpsTXTReplace = "http://";
        private static string wsTXTReplace = "ws://";
        private static bool UseHTTPS = false;
        private static bool logger;

        // HTML placeholders
        private static string avatarsettingsHTML = "..."; // your HTML string here

        public static Dictionary<(string, string), bool> lockStates = new Dictionary<(string, string), bool>();
        public static Dictionary<(string, string), float> parametersStates = new Dictionary<(string, string), float>();
        private static Dictionary<string, string> vRCDefaultParameters = new Dictionary<string, string>
        {
            { "IsLocal", "Bool" },
            { "PreviewMode", "Int" },
            { "Viseme", "Int" },
            { "Voice", "Float" },
            { "GestureLeft", "Int" },
            { "GestureRight", "Int" },
            { "GestureLeftWeight", "Float" },
            { "GestureRightWeight", "Float" },
            { "AngularY", "Float" },
            { "VelocityX", "Float" },
            { "VelocityY", "Float" },
            { "VelocityZ", "Float" },
            { "VelocityMagnitude", "Float" },
            { "Upright", "Float" },
            { "Grounded", "Bool" },
            { "Seated", "Bool" },
            { "AFK", "Bool" },
            { "TrackingType", "Int" },
            { "VRMode", "Int" },
            { "MuteSelf", "Bool" },
            { "InStation", "Bool" },
            { "Earmuffs", "Bool" },
            { "IsOnFriendsList", "Bool" },
            { "AvatarVersion", "Int" },
            { "IsAnimatorEnabled", "Bool" },

            // Avatar Scaling Parameters
            { "ScaleModified", "Bool" },
            { "ScaleFactor", "Float" },
            { "ScaleFactorInverse", "Float" },
            { "EyeHeightAsMeters", "Float" },
            { "EyeHeightAsPercent", "Float" },
        };

        
        public static Dictionary<string, JObject> ScriptStore = new Dictionary<string, JObject>();

        // Script engine state
        private static Dictionary<int, ScriptContext> activeScripts = new Dictionary<int, ScriptContext>();
        private static System.Timers.Timer updateTimer;
        private static System.Timers.Timer networkUpdateTimer;
        #endregion
        
        #region Script Engine
        public class ScriptContext
        {
            public int Slot { get; set; }
            public string AvatarID { get; set; }
            public Engine JintEngine { get; set; }
            public string GeneratedCode { get; set; }
            public Dictionary<string, object> UserVariables { get; set; } = new();
            public bool IsRunning { get; set; }
        }

        private static void InitializeScriptEngine()
        {
            // 60 FPS update timer
            updateTimer = new System.Timers.Timer(1000.0 / 60.0);
            updateTimer.Elapsed += (s, e) => TriggerUpdateEvent();
            updateTimer.Start();

            // 10 FPS network update timer
            networkUpdateTimer = new System.Timers.Timer(1000.0 / 10.0);
            networkUpdateTimer.Elapsed += (s, e) => TriggerNetworkUpdateEvent();
            networkUpdateTimer.Start();

            Console.WriteLine("Script engine initialized with Update (60Hz) and NetworkUpdate (10Hz) timers.");
        }

        private static void LoadAndStartScript(int slot)
        {
            if (CurrentID == "none") return;

            var filePath = Path.Combine("states", $"{CurrentID}_state_{slot}.json");
            if (!File.Exists(filePath)) return;

            try
            {
                var json = File.ReadAllText(filePath);
                var state = JsonConvert.DeserializeObject<ScriptState>(json);

                if (string.IsNullOrEmpty(state?.GeneratedScript))
                {
                    Console.WriteLine($"No script found in slot {slot}");
                    return;
                }

                StopScript(slot);

                var context = new ScriptContext
                {
                    Slot = slot,
                    AvatarID = CurrentID,
                    GeneratedCode = state.GeneratedScript,
                    UserVariables = state.UserVariables ?? new Dictionary<string, object>(),
                    IsRunning = true
                };

                var engine = new Engine(options =>
                {
                    options.TimeoutInterval(TimeSpan.FromSeconds(5));
                    options.LimitRecursion(100);
                });

                // Bridge OSC parameters to JavaScript
                BridgeParametersToScript(engine);

                // Add custom API functions
                engine.SetValue("setParameter", new Action<string, object>((name, value) =>
                {
                    SetParameterFromScript(name, value);
                }));

                engine.SetValue("getParameter", new Func<string, object>((name) =>
                {
                    return GetParameterFromScript(name);
                }));

                engine.SetValue("log", new Action<object>((msg) =>
                {
                    Console.WriteLine($"[Script {slot}] {msg}");
                }));

                engine.SetValue("sendOSC", new Action<string, object, string>((param, value, type) =>
                {
                    SendOscFromScript(param, value, type);
                }));

                context.JintEngine = engine;
                activeScripts[slot] = context;

                // Execute the script to define functions
                engine.Execute(state.GeneratedScript);

                // Trigger OnStart event
                TriggerScriptEvent(slot, "onStart");

                Console.WriteLine($"Script loaded and started for slot {slot}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading script for slot {slot}: {ex.Message}");
            }
        }

        private static void StopScript(int slot)
        {
            if (activeScripts.ContainsKey(slot))
            {
                activeScripts[slot].IsRunning = false;
                activeScripts.Remove(slot);
                Console.WriteLine($"Script stopped for slot {slot}");
            }
        }

        private static void BridgeParametersToScript(Engine engine)
        {
            foreach (var param in parametersStates)
            {
                var cleanName = param.Key.Item1.Replace("/avatar/parameters/", "").Replace("/", "_");
                engine.SetValue(cleanName, param.Value);
            }
        }

        private static object GetParameterFromScript(string name)
        {
            var address = $"/avatar/parameters/{name}";
            foreach (var param in parametersStates)
            {
                if (param.Key.Item1 == address)
                    return param.Value;
            }
            return 0f;
        }

        private static void SetParameterFromScript(string name, object value)
        {
            var address = $"/avatar/parameters/{name}";
            float floatValue = Convert.ToSingle(value);

            foreach (var param in parametersStates.Keys.ToList())
            {
                if (param.Item1 == address)
                {
                    parametersStates[param] = floatValue;
                    SendOscFromScript(address, floatValue, param.Item2);
                    break;
                }
            }
        }

        private static async void SendOscFromScript(string param, object value, string type)
        {
            try
            {
                var oscSender = new UdpClient("127.0.0.1", oscPortOut);

                if (type == "Float" && float.TryParse(value.ToString(), out var floatValue))
                {
                    var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), new object[] { floatValue });
                    await oscSender.SendMessageAsync(message);
                }
                else if (type == "Int" && int.TryParse(value.ToString(), out var intValue))
                {
                    var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), new object[] { intValue });
                    await oscSender.SendMessageAsync(message);
                }
                else if (type == "Bool")
                {
                    var boolValue = value.ToString().ToLower() == "true" || value.ToString() == "1";
                    var message = new OscMessage(
                        address: new Address(param),
                        arguments: new object[] { boolValue ? CoreOSC.OscTrue.True : CoreOSC.OscFalse.False });
                    await oscSender.SendMessageAsync(message);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending OSC from script: {ex.Message}");
            }
        }

        private static void TriggerScriptEvent(int slot, string eventName, params object[] args)
        {
            if (!activeScripts.ContainsKey(slot) || !activeScripts[slot].IsRunning)
                return;

            try
            {
                var engine = activeScripts[slot].JintEngine;
                var function = engine.GetValue(eventName);

                if (function.IsUndefined())
                    return;

                engine.Invoke(eventName, args);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error executing {eventName} in slot {slot}: {ex.Message}");
            }
        }

        private static void TriggerUpdateEvent()
        {
            foreach (var slot in activeScripts.Keys.ToList())
            {
                TriggerScriptEvent(slot, "onUpdate");
            }
        }

        private static void TriggerNetworkUpdateEvent()
        {
            foreach (var slot in activeScripts.Keys.ToList())
            {
                TriggerScriptEvent(slot, "onNetworkUpdate");
            }
        }

        public static void TriggerParameterChangedEvent(string paramName, object value)
        {
            foreach (var slot in activeScripts.Keys.ToList())
            {
                TriggerScriptEvent(slot, "onParameterChanged", paramName, value);
            }
        }
        #endregion


        #region HTML Templates
        private static string GetBlocklyModalHtml()
        {
            string wsProtocol = UseHTTPS ? "wss://" : "ws://";
            string wsUrl = string.IsNullOrEmpty(DNS) ? $"{wsProtocol}{PUBIP}" : $"{wsProtocol}{DNS}";
            if ((webPort != 80 && !UseHTTPS) || (webPort != 443 && UseHTTPS))
                wsUrl += $":{webPort}";

            return $@"
                <div id=""scripting-modal"" style=""display:none;"">
                    <div id=""scripting-content"">
                        <div style=""display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"">
                            <h2 style=""margin:0;"">Blockly Script Editor</h2>
                            <div style=""display:flex; gap:8px;"">
                                <button onclick=""runScript()"" style=""background:#4caf50; padding:8px 16px; border:none; border-radius:6px; color:#000; cursor:pointer;"">‚ñ∂ Run Script</button>
                                <button onclick=""saveScript()"" style=""background:#2196f3; padding:8px 16px; border:none; border-radius:6px; color:#fff; cursor:pointer;"">üíæ Save</button>
                                <button id=""close-scripting"" onclick=""closeScripting()"" style=""background:#f44336; padding:8px 16px; border:none; border-radius:6px; color:#fff; cursor:pointer;"">‚úï Close</button>
                            </div>
                        </div>
                        <div style=""display:flex; gap:10px; height:calc(100% - 60px);"">
                            <div style=""width:200px; background:#0d0d0d; border-radius:6px; padding:10px; overflow-y:auto;"">
                                <h3 style=""margin:0 0 10px 0; font-size:14px;"">Script Slots</h3>
                                {GenerateScriptSlotButtons()}
                            </div>
                            <div id=""blocklyDiv"" style=""flex:1; border-radius:6px;""></div>
                            <div style=""width:400px; display:flex; flex-direction:column; gap:10px;"">
                                <div style=""background:#0d0d0d; border-radius:6px; padding:10px; height:50%;"">
                                    <h3 style=""margin:0 0 10px 0; font-size:14px;"">Generated Code</h3>
                                    <pre id=""generatedCode"" style=""background:#000; padding:10px; border-radius:4px; font-family:monospace; font-size:12px; overflow:auto; height:calc(100% - 30px); margin:0;""></pre>
                                </div>
                                <div style=""background:#0d0d0d; border-radius:6px; padding:10px; height:50%;"">
                                    <h3 style=""margin:0 0 10px 0; font-size:14px;"">Console Output</h3>
                                    <pre id=""scriptConsole"" style=""background:#000; padding:10px; border-radius:4px; font-family:monospace; font-size:12px; overflow:auto; height:calc(100% - 30px); margin:0;""></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script src=""https://unpkg.com/blockly/blockly.min.js""></script>
                <script>
                    let blocklyWorkspace;
                    let currentScriptSlot = 0;

                    function openScripting() {{
                        document.getElementById('scripting-modal').style.display = 'flex';
                        if (!blocklyWorkspace) {{
                            initBlockly();
                        }}
                    }}

                    function closeScripting() {{
                        document.getElementById('scripting-modal').style.display = 'none';
                    }}

                    function selectScriptSlot(slot) {{
                        currentScriptSlot = slot;
                        document.querySelectorAll('.script-slot-btn').forEach(b => b.classList.remove('active'));
                        document.getElementById('slot-btn-' + slot).classList.add('active');
                        loadScriptFromSlot(slot);
                    }}

                    function loadScriptFromSlot(slot) {{
                        fetch('/getScript?slot=' + slot)
                            .then(r => r.json())
                            .then(data => {{
                                if (data.workspace) {{
                                    blocklyWorkspace.clear();
                                    const xml = Blockly.utils.xml.textToDom(data.workspace);
                                    Blockly.Xml.domToWorkspace(xml, blocklyWorkspace);
                                }}
                            }})
                            .catch(err => console.error('Failed to load script:', err));
                    }}

                    function saveScript() {{
                        const xml = Blockly.Xml.workspaceToDom(blocklyWorkspace);
                        const xmlText = Blockly.Xml.domToText(xml);
                        const code = Blockly.JavaScript.workspaceToCode(blocklyWorkspace);

                        fetch('/saveScript', {{
                            method: 'POST',
                            headers: {{ 'Content-Type': 'application/json' }},
                            body: JSON.stringify({{
                                slot: currentScriptSlot,
                                workspace: xmlText,
                                code: code
                            }})
                        }})
                        .then(r => r.text())
                        .then(msg => {{
                            logToConsole('Script saved to slot ' + currentScriptSlot);
                            alert(msg);
                        }});
                    }}

                    function runScript() {{
                        fetch('/runScript?slot=' + currentScriptSlot, {{ method: 'POST' }})
                            .then(r => r.text())
                            .then(msg => {{
                                logToConsole('Script started: ' + msg);
                            }});
                    }}

                    function logToConsole(msg) {{
                        const console = document.getElementById('scriptConsole');
                        const time = new Date().toLocaleTimeString();
                        console.textContent += `[${{time}}] ${{msg}}\\n`;
                        console.scrollTop = console.scrollHeight;
                    }}

                    function initBlockly() {{
                        const toolbox = {{
                            'kind': 'categoryToolbox',
                            'contents': [
                                {{
                                    'kind': 'category',
                                    'name': 'üéÆ Events',
                                    'colour': '#FF6B6B',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'on_start'}},
                                        {{'kind': 'block', 'type': 'on_parameter_changed'}},
                                        {{'kind': 'block', 'type': 'on_update'}},
                                        {{'kind': 'block', 'type': 'on_network_update'}}
                                    ]
                                }},
                                {{
                                    'kind': 'category',
                                    'name': 'üì° OSC Parameters',
                                    'colour': '#4ECDC4',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'get_parameter'}},
                                        {{'kind': 'block', 'type': 'set_parameter'}},
                                        {{'kind': 'block', 'type': 'send_osc'}}
                                    ]
                                }},
                                {{
                                    'kind': 'category',
                                    'name': 'üî¢ Variables',
                                    'colour': '#A65CA6',
                                    'custom': 'VARIABLE'
                                }},
                                {{
                                    'kind': 'category',
                                    'name': 'üîÄ Logic',
                                    'colour': '#5C81A6',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'controls_if'}},
                                        {{'kind': 'block', 'type': 'logic_compare'}},
                                        {{'kind': 'block', 'type': 'logic_operation'}},
                                        {{'kind': 'block', 'type': 'logic_boolean'}}
                                    ]
                                }},
                                {{
                                    'kind': 'category',
                                    'name': 'üîÅ Loops',
                                    'colour': '#5CA65C',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'controls_repeat_ext'}},
                                        {{'kind': 'block', 'type': 'controls_whileUntil'}},
                                        {{'kind': 'block', 'type': 'controls_for'}}
                                    ]
                                }},
                                {{
                                    'kind': 'category',
                                    'name': '‚ûó Math',
                                    'colour': '#5C68A6',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'math_number'}},
                                        {{'kind': 'block', 'type': 'math_arithmetic'}},
                                        {{'kind': 'block', 'type': 'math_single'}},
                                        {{'kind': 'block', 'type': 'math_round'}}
                                    ]
                                }},
                                {{
                                    'kind': 'category',
                                    'name': 'üìù Text',
                                    'colour': '#5CA68D',
                                    'contents': [
                                        {{'kind': 'block', 'type': 'text'}},
                                        {{'kind': 'block', 'type': 'text_print'}},
                                        {{'kind': 'block', 'type': 'text_join'}}
                                    ]
                                }}
                            ]
                        }};

                        blocklyWorkspace = Blockly.inject('blocklyDiv', {{
                            toolbox: toolbox,
                            grid: {{ spacing: 20, length: 3, colour: '#2a2a2a', snap: true }},
                            zoom: {{ controls: true, wheel: true, startScale: 1.0 }},
                            trashcan: true,
                            theme: Blockly.Theme.defineTheme('dark', {{
                                'base': Blockly.Themes.Classic,
                                'componentStyles': {{
                                    'workspaceBackgroundColour': '#1a1a1a',
                                    'toolboxBackgroundColour': '#0d0d0d',
                                    'flyoutBackgroundColour': '#121212'
                                }}
                            }})
                        }});

                        defineCustomBlocks();

                        blocklyWorkspace.addChangeListener(() => {{
                            const code = Blockly.JavaScript.workspaceToCode(blocklyWorkspace);
                            document.getElementById('generatedCode').textContent = code || '// No blocks yet';
                        }});

                        selectScriptSlot(0);
                    }}

                    function defineCustomBlocks() {{
                        // Event: OnStart
                        Blockly.Blocks['on_start'] = {{
                            init: function() {{
                                this.appendDummyInput().appendField('üé¨ When script starts');
                                this.appendStatementInput('DO').setCheck(null);
                                this.setColour('#FF6B6B');
                                this.setTooltip('Runs once when the script is loaded');
                            }}
                        }};
                        Blockly.JavaScript['on_start'] = function(block) {{
                            const statements = Blockly.JavaScript.statementToCode(block, 'DO');
                            return `function onStart() {{\\n${{statements}}}}\\n`;
                        }};

                        // Event: OnParameterChanged
                        Blockly.Blocks['on_parameter_changed'] = {{
                            init: function() {{
                                this.appendDummyInput()
                                    .appendField('üîî When parameter')
                                    .appendField(new Blockly.FieldTextInput('paramName'), 'PARAM')
                                    .appendField('changes');
                                this.appendStatementInput('DO').setCheck(null);
                                this.setColour('#FF6B6B');
                            }}
                        }};
                        Blockly.JavaScript['on_parameter_changed'] = function(block) {{
                            const param = block.getFieldValue('PARAM');
                            const statements = Blockly.JavaScript.statementToCode(block, 'DO');
                            return `function onParameterChanged(name, value) {{\\n  if (name === '${{param}}') {{\\n${{statements}}  }}\\n}}\\n`;
                        }};

                        // Event: OnUpdate (60Hz)
                        Blockly.Blocks['on_update'] = {{
                            init: function() {{
                                this.appendDummyInput().appendField('‚ö° On Update (60 FPS)');
                                this.appendStatementInput('DO').setCheck(null);
                                this.setColour('#FF6B6B');
                            }}
                        }};
                        Blockly.JavaScript['on_update'] = function(block) {{
                            const statements = Blockly.JavaScript.statementToCode(block, 'DO');
                            return `function onUpdate() {{\\n${{statements}}}}\\n`;
                        }};

                        // Event: OnNetworkUpdate (10Hz)
                        Blockly.Blocks['on_network_update'] = {{
                            init: function() {{
                                this.appendDummyInput().appendField('üåê On Network Update (10 FPS)');
                                this.appendStatementInput('DO').setCheck(null);
                                this.setColour('#FF6B6B');
                            }}
                        }};
                        Blockly.JavaScript['on_network_update'] = function(block) {{
                            const statements = Blockly.JavaScript.statementToCode(block, 'DO');
                            return `function onNetworkUpdate() {{\\n${{statements}}}}\\n`;
                        }};

                        // Get Parameter
                        Blockly.Blocks['get_parameter'] = {{
                            init: function() {{
                                this.appendDummyInput()
                                    .appendField('Get')
                                    .appendField(new Blockly.FieldTextInput('paramName'), 'PARAM');
                                this.setOutput(true, 'Number');
                                this.setColour('#4ECDC4');
                            }}
                        }};
                        Blockly.JavaScript['get_parameter'] = function(block) {{
                            const param = block.getFieldValue('PARAM');
                            return [`getParameter('${{param}}')`, Blockly.JavaScript.ORDER_FUNCTION_CALL];
                        }};

                        // Set Parameter
                        Blockly.Blocks['set_parameter'] = {{
                            init: function() {{
                                this.appendValueInput('VALUE')
                                    .appendField('Set')
                                    .appendField(new Blockly.FieldTextInput('paramName'), 'PARAM')
                                    .appendField('to');
                                this.setPreviousStatement(true, null);
                                this.setNextStatement(true, null);
                                this.setColour('#4ECDC4');
                            }}
                        }};
                        Blockly.JavaScript['set_parameter'] = function(block) {{
                            const param = block.getFieldValue('PARAM');
                            const value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_NONE) || '0';
                            return `setParameter('${{param}}', ${{value}});\\n`;
                        }};

                        // Send OSC
                        Blockly.Blocks['send_osc'] = {{
                            init: function() {{
                                this.appendValueInput('VALUE')
                                    .appendField('Send OSC')
                                    .appendField(new Blockly.FieldTextInput('/avatar/parameters/param'), 'PARAM')
                                    .appendField(new Blockly.FieldDropdown([['Float', 'Float'], ['Int', 'Int'], ['Bool', 'Bool']]), 'TYPE')
                                    .appendField('value');
                                this.setPreviousStatement(true, null);
                                this.setNextStatement(true, null);
                                this.setColour('#4ECDC4');
                            }}
                        }};
                        Blockly.JavaScript['send_osc'] = function(block) {{
                            const param = block.getFieldValue('PARAM');
                            const type = block.getFieldValue('TYPE');
                            const value = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_NONE) || '0';
                            return `sendOSC('${{param}}', ${{value}}, '${{type}}');\\n`;
                        }};
                    }}
                </script>";
        }

        private static string GenerateScriptSlotButtons()
        {
            var sb = new StringBuilder();
            for (int i = 0; i < saveCount; i++)
            {
                var activeClass = i == 0 ? "active" : "";
                sb.AppendLine($@"<button id=""slot-btn-{i}"" class=""script-slot-btn {activeClass}"" onclick=""selectScriptSlot({i})"" style=""width:100%; padding:8px; margin:4px 0; border:none; border-radius:4px; background:#333; color:#e0e0e0; cursor:pointer;"">Slot #{i}</button>");
            }
            return sb.ToString();
        }

        private static string SimpleRedirect()
        {
            return @"<!DOCTYPE html>
                <html lang=""en"">
                <head>
                    <meta charset=""UTF-8"">
                    <meta http-equiv=""refresh"" content=""0; url=" + httpsTXTReplace + DNS + @"/"" />
                    <title>Redirecting...</title>
                </head>
                <body>
                    <p>If you are not redirected automatically, follow this <a href=""" + httpsTXTReplace + DNS + @"/"">link</a>.</p>
                </body>
                </html>";
        }

        private static string GetIndexHtml(bool isHost, string currentID = "none")
        {
            var settingsButton = isHost ? $@"<button onclick=""location.href='/settings'"">Setting page</button>
                                             <button onclick=""location.href='/routing'"">Routing page</button>
                                             <button onclick=""location.href='/parameter'"">Parameters page</button>
                                             <button onclick='openScripting()'>Open Scripting</button>" : "";
            var injectAvatarToggle = "";
            if (currentID != "none")
            {
                injectAvatarToggle = UpdateHtml(currentID, isHost);
            }

            return @"<!DOCTYPE html>
                <html lang=""en"">
                <head>
                <meta charset=""UTF-8"">
                <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
                <style>
                    body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Arial, sans-serif; padding: 12px; }
                    h1 { margin: 8px 0 12px 0; }
                    .top-bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
                    .controls { display:flex; gap:8px; align-items:center; margin: 10px 0; }
                    .controls button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; background:#333; color:#e0e0e0; }
                    .controls button.active { background:#4caf50; color:#061206; }
                    #parameters-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; align-items: start;}
                    .parameter-container { border:1px solid #333; padding:10px; border-radius:8px; background:#1a1a1a; }
                    .side-panel { position: fixed; left: 0; top: 0; width: 180px; height: 100%; background: #1a1a1a; border-right: 1px solid #333; padding: 10px; overflow-y: auto; }
                    .side-panel button { padding: 6px 8px; border-radius: 6px; border: none; background: #333; color: #e0e0e0; cursor: pointer; }
                    
                    #scripting-modal { 
                        position: fixed; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.9); 
                        z-index: 1000; 
                        display: none; 
                        align-items: center; 
                        justify-content: center; 
                    }
                    #scripting-content { 
                        background: #1a1a1a; 
                        border-radius: 10px; 
                        width: 95%; 
                        height: 90%; 
                        padding: 20px; 
                        display: flex; 
                        flex-direction: column; 
                    }
                    .script-slot-btn.active { background: #4caf50 !important; }
                </style>
                </head>
                <body>

                <div class='side-panel'>
                    " + settingsButton + @"
                    <div class='save-load-panel'>
                        " + GenerateSaveLoadButtonsHtml() + @"
                    </div>
                </div>

                <div style='margin-left:200px; padding:12px;'>
                    <h1>OSC Remote Control Panel</h1>
                    <div class=""controls"">
                        <div id=""sort-buttons"">
                            <button id=""sort-default"" class=""active"">Unsorted</button>
                        </div>
                    </div>

                    <div id=""parameters-grid""></div>
                    
                    " + GetBlocklyModalHtml() + @"
                    
                    " + injectAvatarToggle + @"

                    <footer>
                        <p>Current OSC avatar ID: " + (currentID != "none" ? currentID : "no avatar loaded") + @"</p>
                    </footer>
                </div>

                <script>
                    const ws = new WebSocket(`" + DNS + @"/ws`);
                    ws.onopen = () => console.log('WebSocket connected');
                    ws.onmessage = event => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.action === 'updateHtml') {
                                window.location.reload();
                            }
                        } catch (err) {
                            console.warn('ws error', err);
                        }
                    };
                    
                    function saveState(slot) {
                        fetch(`/saveState?slot=${slot}`, { method:'POST' });
                    }
                    
                    function loadState(slot) {
                        fetch(`/loadState?slot=${slot}`).then(r => r.json());
                    }
                </script>
                </body>
            </html>";
        }
        #endregion

        #region Main Entry
        static async Task Main(string[] args)
        {
            await BlocklyHandler.Blockly.BLMain(args);
            return;
            ParseArguments(args);
            await ConfigureHTTPSIfNeeded();
            await FetchPublicIP();
            PrintServerAddress();

            StartOscListener();
            StartOscSender();
            Router("parameters/Routing.json");
            StartWebServer();
        }
        #endregion

        #region HTTPS & Network Helpers
        private static async Task ConfigureHTTPSIfNeeded()
        {
            if (!UseHTTPS) return;

            string certFilePath = "./cert/certificate.crt";
            string keyFilePath = "./cert/private.key";
            string pfxFilePath = "./cert/certificate.pfx";
            string password = "your_password";
            GeneratePfx(certFilePath, keyFilePath, pfxFilePath, password);
        }

        public static void GeneratePfx(string certFilePath, string keyFilePath, string pfxFilePath, string password)
        {
            try
            {
                if (!File.Exists(certFilePath) || !File.Exists(keyFilePath))
                {
                    Console.WriteLine("Certificate files not found, skipping PFX generation");
                    return;
                }

                var cert = new X509Certificate2(certFilePath);
                string privateKeyText = File.ReadAllText(keyFilePath);

                using (RSA rsa = RSA.Create())
                {
                    rsa.ImportFromPem(privateKeyText.ToCharArray());
                    var pfx = new X509Certificate2Collection(cert);
                    pfx[0] = pfx[0].CopyWithPrivateKey(rsa);
                    File.WriteAllBytes(pfxFilePath, pfx.Export(X509ContentType.Pfx, password));
                    Console.WriteLine($"PFX file created: {pfxFilePath}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error generating PFX: {ex.Message}");
            }
        }

        private static async Task FetchPublicIP()
        {
            try
            {
                using HttpClient client = new HttpClient();
                PUBIP = await client.GetStringAsync("https://api.ipify.org");
            }
            catch { PUBIP = "localhost"; }
        }

        private static void PrintServerAddress()
        {
            string ip = DNS = string.IsNullOrEmpty(DNS) ? PUBIP : DNS;
            string portSuffix = (webPort != 80 && !UseHTTPS) && (webPort != 443 && UseHTTPS) ? $":{webPort}" : "";
            Console.WriteLine($"Your public IP address is: {ip}{portSuffix}");
        }

        private static bool IsLocalhostRequest(HttpContext context) =>
            context.Connection.RemoteIpAddress.ToString() == "::1" ||
            context.Connection.RemoteIpAddress.ToString() == "::ffff:127.0.0.1" ||
            context.Connection.RemoteIpAddress.ToString() == $"::ffff:{PUBIP}" ||
            context.Connection.RemoteIpAddress.ToString() == PUBIP;
        #endregion

        #region OSC
        private static void StartOscListener()
        {
            var udpClient = new UdpClient(oscPortIn);
            Task.Run(async () =>
            {
                while (true)
                {
                    var packet = await udpClient.ReceiveMessageAsync();
                    await HandleOscPacket(packet);
                }
            });
        }

        private static async Task HandleOscPacket(OscMessage packet)
        {
            var messageReceived = packet;
            if (messageReceived.Address.Value == "/avatar/change")
            {
                string value = messageReceived.Arguments.ToArray()[0].ToString();
                if (CheckAvatarId(File.ReadAllText("parameters/AvatarListing.json"), value))
                {
                    Console.WriteLine("Avatar Changed to ID: " + value);
                    if (CurrentID != value)
                    {
                        CurrentID = value;
                        lockStates.Clear();
                        parametersStates.Clear();
                        var broadcastMessage = "{\"action\":\"updateHtml\"}";
                        await WebSocketHandler.BroadcastMessage(broadcastMessage);
                    }
                }
            }
            else
            {
                var type = messageReceived.Arguments.FirstOrDefault()?.GetType().Name;
                type = type.Replace("Single", "Float").Replace("Int32", "Int").Replace("OscFalse", "Bool").Replace("OscTrue", "Bool");
                var param = messageReceived.Address.Value.Replace("/avatar/parameters/", "");
                var value = messageReceived.Arguments.FirstOrDefault()?.ToString()?.Replace("CoreOSC.OscFalse", "f").Replace("CoreOSC.OscTrue", "t");
                if (lockStates.ContainsKey((messageReceived.Address.Value, type)) && lockStates[(messageReceived.Address.Value, type)])
                {
                    Console.WriteLine("OSC Message to " + messageReceived.Address.Value + " is locked. Ignoring.");
                    var checkValue = 1f;
                    if (value != "f" && value != "t") checkValue = float.TryParse(value, out var f) ? f : 0f;
                    else if (value == "t") checkValue = 1f;
                    else checkValue = 0f;

                    if (parametersStates[(messageReceived.Address.Value, type)] == checkValue)
                    {
                        Console.WriteLine("OSC Message to " + messageReceived.Address.Value + " is locked and is same. Ignoring.");
                        return;
                    }

                    var oscSender = new UdpClient("127.0.0.1", oscPortOut);

                    var paramm = messageReceived.Address.Value;
                    var overrideValue = parametersStates[(messageReceived.Address.Value, type)];

                    if (type == "Float")
                    {

                        var message = new CoreOSC.OscMessage(new CoreOSC.Address($"{paramm}"), [overrideValue]);
                        await oscSender.SendMessageAsync(message);
                    }
                    else if (type == "Int")
                    {
                        var message = new CoreOSC.OscMessage(new CoreOSC.Address($"{paramm}"), [overrideValue]);
                        await oscSender.SendMessageAsync(message);
                    }
                    else if (type == "Bool")
                    {
                        var message = new OscMessage();
                        if (overrideValue == 1f)
                        {
                            message = new OscMessage(
                            address: new Address($"{paramm}"),
                            arguments: new object[] { CoreOSC.OscTrue.True });
                        }
                        else
                        {
                            message = new OscMessage(
                            address: new Address($"{paramm}"),
                            arguments: new object[] { CoreOSC.OscFalse.False });
                        }
                        await oscSender.SendMessageAsync(message);
                    }

                    Console.WriteLine("OSC Message to " + messageReceived.Address.Value + " is locked. Ignoring.");
                    return;
                }

                if (value != "f" && value != "t") parametersStates[(messageReceived.Address.Value, type)] = float.TryParse(value, out var f) ? f : 0f;
                else parametersStates[(messageReceived.Address.Value, type)] = (value == "t") ? 1f : 0f;
                var broadcastMessage = "{\"param\":\"" + param.Replace("/", "_") + "\",\"value\":\"" + value + "\"}";
                await WebSocketHandler.BroadcastMessage(broadcastMessage);
            }
        }

        private static void StartOscSender()
        {
            using (var udpClient = new UdpClient("127.0.0.1", oscPortIn))
            {
                var message = new OscMessage(
                 address: new Address("/Program Started"),
                 arguments: new object[] { "true" });
                udpClient.SendMessageAsync(message).Wait();
            }
        }

        public static bool CheckAvatarId(string json, string input)
        {
            var avatarList = JsonConvert.DeserializeObject<AvatarList>(json);
            bool isInList = Array.Exists(avatarList.AvatarIds, id => id.Equals(input, StringComparison.OrdinalIgnoreCase));
            return avatarList.IsWhiteList ? isInList : !isInList;
        }
        #endregion

        #region Routing
        public static void Router(string configFilePath)
        {
            var routes = LoadRoutingConfig(configFilePath);
            if (routes == null) return;

            foreach (var route in routes)
            {
                int inputPort = ResolvePort(route.InputPort);
                if (inputPort <= 0) continue;

                var udpClient = new UdpClient(inputPort);
                Task.Run(async () =>
                {
                    while (true)
                    {
                        var packet = await udpClient.ReceiveMessageAsync();
                        foreach (var output in route.Outputs)
                        {
                            int outputPort = ResolvePort(output.Port);
                            if (outputPort > 0)
                            {
                                using var senderClient = new UdpClient(output.Ip, outputPort);
                                await senderClient.SendMessageAsync(packet);
                            }
                        }
                    }
                });
            }
        }

        public static List<UdpRoute> LoadRoutingConfig(string filePath)
        {
            return File.Exists(filePath)
                ? JsonConvert.DeserializeObject<List<UdpRoute>>(File.ReadAllText(filePath))
                : null;
        }

        public static int ResolvePort(string port) =>
            port switch
            {
                "oscPortIn" => oscPortIn,
                "oscPortOut" => oscPortOut,
                _ => int.TryParse(port, out var p) ? p : -1
            };
        #endregion

        #region Web Server
        private static void StartWebServer()
        {
            var builder = WebHost.CreateDefaultBuilder()
                .ConfigureKestrel(options =>
                {
                  options.Limits.MaxRequestBodySize = null;
                  if (File.Exists("./cert/certificate.pfx"))
                  {
                    options.ListenAnyIP(443, listenOptions =>
                    {
                      listenOptions.UseHttps("./cert/certificate.pfx", "your_password");
                    });
                  }
                  options.ListenAnyIP(8080);
                })
                .ConfigureServices(services => services.AddRouting())
                .Configure(app =>
                {
                    app.UseWebSockets();
                    app.UseRouting();

                    app.Use(async (context, next) =>
                    {
                        if (context.Request.Path == "/ws" || context.Request.Path == "/" + DNS + "/ws")
                        {
                            Console.WriteLine("HEY THIS GOT TRIGGERD");
                            // Console.WriteLine(context.WebSockets.IsWebSocketRequest);
                            if (context.WebSockets.IsWebSocketRequest)
                            {
                                var webSocket = await context.WebSockets.AcceptWebSocketAsync();
                                var handler = new WebSocketHandler(webSocket);
                                await handler.HandleAsync();
                            }
                            else
                            {
                                context.Response.StatusCode = StatusCodes.Status400BadRequest;
                            }
                        }
                        if (context.Request.Path == "/settingsocket" || context.Request.Path == "/" + DNS + "/settingsocket")
                        {
                            Console.WriteLine("settingsocket accepted");
                            if (context.WebSockets.IsWebSocketRequest)
                            {
                                var webSocket = await context.WebSockets.AcceptWebSocketAsync();
                                var handler = new WebSocketHandler(webSocket);
                                await handler.HandleAsync();

                            }
                            else
                            {
                                context.Response.StatusCode = StatusCodes.Status400BadRequest;
                            }
                        }
                        else
                        {
                            await next();
                        }
                    });

                    app.UseEndpoints(endpoints =>
                    {
                        MapWebEndpoints(endpoints);
                    });
                });

            if (UseHTTPS)
                builder.UseUrls($"https://*:{webPort}");
            else
                builder.UseUrls($"http://*:{webPort}");

            webHost = builder.Build();
            webHost.Run();
        }

        private static void MapWebEndpoints(Microsoft.AspNetCore.Routing.IEndpointRouteBuilder endpoints)
        {
            // Map all endpoints here
            endpoints.MapGet("/", async context =>
            {
                Console.WriteLine(context.Connection.RemoteIpAddress.ToString());
                var ishost = IsLocalhostRequest(context);
                string html = GetIndexHtml(ishost, CurrentID);
                await context.Response.WriteAsync(html);
            });

            // Map all endpoints here
            endpoints.MapGet("/fuckoff", async context =>
            {
                Environment.Exit(0);
                await context.Response.WriteAsync("No.");
            });

            endpoints.MapGet("/settings", async context =>
            {
                var ishost = IsLocalhostRequest(context);
                if (!ishost) {await context.Response.WriteAsync(SimpleRedirect()); return; }
                string html = GetIndexHtml(ishost);
                await context.Response.WriteAsync(html);
            });
            endpoints.MapGet("/routing", async context =>
            {
                var ishost = IsLocalhostRequest(context);
                if (!ishost) {await context.Response.WriteAsync(SimpleRedirect()); return; }
                string html = GetIndexHtml(ishost);
                await context.Response.WriteAsync(html);
            });
            endpoints.MapGet("/parameter", async context =>
            {
                var ishost = IsLocalhostRequest(context);
                if (!ishost) {await context.Response.WriteAsync(SimpleRedirect()); return; }
                string html = GetParametersHtml();
                await context.Response.WriteAsync(html);
            });

            endpoints.MapPost("/saveState", async context =>
            {
                var slot = context.Request.Query["slot"].ToString();
                var state = new State();
                //use parametersStates to build state
                state.Toggles = parametersStates
                    .Where(kv => kv.Key.Item2 == "Bool" && !IsParameterBlocked(kv.Key.Item1, "Bool"))
                    .Select(kv => new Toggle
                    {
                        Id = kv.Key.Item1.Replace("/avatar/parameters/", ""),
                        Checked = kv.Value == 1f
                    }).ToList();

                state.Sliders = parametersStates
                    .Where(kv => (kv.Key.Item2 == "Float" || kv.Key.Item2 == "Int") && !IsParameterBlocked(kv.Key.Item1, kv.Key.Item2))
                    .Select(kv => new Slider
                    {
                        Id = kv.Key.Item1.Replace("/avatar/parameters/", ""),
                        Value = kv.Value,
                        Type = kv.Key.Item2
                    }).ToList();

                if (state != null)
                {
                    // Store the state
                    var filePath = Path.Combine("states", $"{CurrentID}_state_{slot}.json");
                    Directory.CreateDirectory("states");
                    await File.WriteAllTextAsync(filePath, JsonConvert.SerializeObject(state));
                    await context.Response.WriteAsync(JsonConvert.SerializeObject(state));
                }
                else
                {
                    await context.Response.WriteAsync("Invalid state");
                }
            });

            endpoints.MapGet("/loadState", async context =>
            {
                var slot = context.Request.Query["slot"].ToString();
                var filePath = Path.Combine("states", $"{CurrentID}_state_{slot}.json");

                if (File.Exists(filePath))
                {
                    var state = await File.ReadAllTextAsync(filePath);
                    var states = JsonConvert.DeserializeObject<State>(state);
                    foreach (var st in states.Toggles)
                    {
                        var param = "/avatar/parameters/" + st.Id;
                        var value = st.Checked ? "t" : "f";
                        var type = "Bool";
                        if (IsParameterBlocked(param, "Bool")) { Console.WriteLine($"Skipping blocked parameter: {param}"); continue; }

                        if (lockStates.ContainsKey((param, type)) && lockStates[(param, type)])
                        {
                            if (parametersStates[(param, type)] == 0f) value = "f";
                            else value = "t";
                            var broadcastMessage = "{\"param\":\"" + context.Request.Query["param"].ToString().Replace("/", "_").Replace("_avatar_parameters_", "") + "\",\"value\":\"" + value + "\"}";
                            await WebSocketHandler.BroadcastMessage(broadcastMessage);
                            await context.Response.WriteAsync("OSC Message Locked");
                            continue;
                        }

                        var oscSender = new UdpClient("127.0.0.1", oscPortOut);

                        parametersStates[(param, type)] = value.ToLower().Contains("t") ? 1f : 0f;

                        var message = new OscMessage();
                        message = new OscMessage(
                        address: new CoreOSC.Address(param),
                        arguments: new object[] { st.Checked ? CoreOSC.OscTrue.True : CoreOSC.OscFalse.False });

                        await oscSender.SendMessageAsync(message);

                    }
                    ;
                    foreach (var st in states.Sliders)
                    {
                        var param = "/avatar/parameters/" + st.Id.Replace("input-", "").Replace("slider-", "");
                        var value = st.Value.ToString();
                        var type = st.Type;

                        if (IsParameterBlocked(param, type)) { Console.WriteLine($"Skipping blocked parameter: {param}"); continue; }

                        if (lockStates.ContainsKey((param, type)) && lockStates[(param, type)])
                        {
                            if (float.TryParse(value, out var f))
                            {
                                if (parametersStates[(param, type)] != f)
                                {
                                    var broadcastMessage = "{\"param\":\"" + context.Request.Query["param"].ToString().Replace("/", "_").Replace("_avatar_parameters_", "") + "\",\"value\":\"" + parametersStates[(param, type)] + "\"}";
                                    await WebSocketHandler.BroadcastMessage(broadcastMessage);
                                }
                            }
                            await context.Response.WriteAsync("OSC Message Locked");
                            continue;
                        }

                        var oscSender = new UdpClient("127.0.0.1", oscPortOut);

                        if (type == "Float" && float.TryParse(value, out var floatValue))
                        {
                            parametersStates[(param, type)] = floatValue;
                            var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), [floatValue]);
                            await oscSender.SendMessageAsync(message);
                        }
                        else if (type == "Int" && int.TryParse(value, out var intValue))
                        {
                            parametersStates[(param, type)] = intValue;
                            var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), [intValue]);
                            await oscSender.SendMessageAsync(message);
                        }
                    }
                    
                    await context.Response.WriteAsync(state);
                }
                else
                {
                    await context.Response.WriteAsync("State not found");
                }
            });

            endpoints.MapGet("/update/{value}", async context =>
            {
                var value = context.Request.RouteValues["value"]?.ToString();
                await context.Response.WriteAsync("Updated");
            });
            endpoints.MapGet("/sendOsc", async context =>
            {
                var param = ToUnicodeEscape(context.Request.Query["param"].ToString());
                var value = context.Request.Query["value"].ToString();
                var type = context.Request.Query["type"].ToString();

                if (lockStates.ContainsKey((param, type)) && lockStates[(param, type)])
                {
                    if (value == "f" || value == "t")
                    {
                        if (parametersStates[(param, type)] == 0f) value = "f";
                        else value = "t";
                        var broadcastMessage = "{\"param\":\"" + context.Request.Query["param"].ToString().Replace("/", "_").Replace("_avatar_parameters_", "") + "\",\"value\":\"" + value + "\"}";
                        await WebSocketHandler.BroadcastMessage(broadcastMessage);
                    }
                    else if (float.TryParse(value, out var f))
                    {
                        if (parametersStates[(param, type)] != f)
                        {
                            var broadcastMessage = "{\"param\":\"" + context.Request.Query["param"].ToString().Replace("/", "_").Replace("_avatar_parameters_", "") + "\",\"value\":\"" + parametersStates[(param, type)] + "\"}";
                            await WebSocketHandler.BroadcastMessage(broadcastMessage);
                        }
                    }
                    await context.Response.WriteAsync("OSC Message Locked");
                    return;
                }

                var oscSender = new UdpClient("127.0.0.1", oscPortOut);

                //Console.WriteLine(param.Replace(" ", " "));

                if (type == "Float" && float.TryParse(value, out var floatValue))
                {
                    parametersStates[(param, type)] = floatValue;
                    var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), [floatValue]);
                    await oscSender.SendMessageAsync(message);
                }
                else if (type == "Int" && int.TryParse(value, out var intValue))
                {
                    parametersStates[(param, type)] = intValue;
                    var message = new CoreOSC.OscMessage(new CoreOSC.Address(param), [intValue]);
                    await oscSender.SendMessageAsync(message);
                }
                else if (type == "Bool")
                {
                    parametersStates[(param, type)] = value.ToLower().Contains("t") ? 1f : 0f;

                    var message = new OscMessage();
                    if (value.ToLower().Contains("t"))
                    {
                        message = new OscMessage(
                        address: new CoreOSC.Address(param),
                        arguments: new object[] { CoreOSC.OscTrue.True });
                    }
                    else
                    {
                        message = new OscMessage(
                        address: new CoreOSC.Address(param),
                        arguments: new object[] { CoreOSC.OscFalse.False });
                    }
                    await oscSender.SendMessageAsync(message);
                }
                await context.Response.WriteAsync("OSC Message Sent " + param + " " + value + " " + type);
            });
            endpoints.MapGet("/togglelock", async context =>
            {
                var param = context.Request.Query["param"].ToString();
                var locked = context.Request.Query["locked"].ToString() == "true";
                var type = context.Request.Query["type"].ToString();
                if (lockStates.ContainsKey((param, type)))
                    lockStates[(param, type)] = locked;
                else
                    lockStates.Add((param, type), locked);
                await context.Response.WriteAsync(param + " " + type + " lock set to " + locked.ToString());
            });

            //for https certification /!\ VERY IMPORTANT /!\
            endpoints.MapGet("/.well-known/{**filePath}", async (HttpContext context, string filePath) =>
            {
                // Normalize the path
                string normalizedPath = Path.Combine(".well-known", filePath.Replace('/', Path.DirectorySeparatorChar));

                if (!File.Exists(normalizedPath))
                {
                    context.Response.StatusCode = 404;
                    await context.Response.WriteAsync("Not found");
                    return;
                }

                await context.Response.SendFileAsync(normalizedPath);
            });


            // Additional endpoints can be added here...
        }
        private static string ToUnicodeEscape(string s)
        {
            if (s == null) return "";

            var sb = new StringBuilder();
            foreach (char c in s)
            {
                if (c <= 127)
                {
                    // ASCII stays the same
                    sb.Append(c);
                }
                else
                {
                    // Non-ASCII becomes \uXXXX
                    sb.Append("\\u");
                    sb.Append(((int)c).ToString("X4"));
                }
            }
            return sb.ToString();
        }
        #endregion

        #region HTML & File Helpers

        private static string PopulateNodeWithParameters(string currentID, bool isHost)
        {
            if (!isHost) return "";

            var oscFolderPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "Low",
                "VRChat", "VRChat", "OSC"
            );

            var jsonFilePath = Directory.GetFiles(oscFolderPath, $"{currentID}.json", SearchOption.AllDirectories)
                                        .FirstOrDefault();

            if (jsonFilePath == null) { Console.WriteLine("JSON file not found."); return ""; }

            var jsonContent = File.ReadAllText(jsonFilePath);
            var json = JObject.Parse(jsonContent);
            var parameters = json["parameters"];

            // Group parameters by their "group" name
            var groups = new Dictionary<string, List<JToken>>();

            foreach (var param in parameters.Reverse())
            {
                if (param["output"] == null) continue;

                var name = param["name"].ToString();
                var address = param["output"]["address"].ToString();
                var id = address.Replace("/avatar/parameters/", "");
                if (id.Contains("/")) id = id.Replace("/", "_");

                var type = param["output"]["type"].ToString();
                if (IsParameterBlocked(id, type)) continue;

                bool isReadOnly = (vRCDefaultParameters.ContainsKey(id) && vRCDefaultParameters[id] == type)
                                  || param["input"] == null;

                // Use VRChat defaults as read-only group
                string group = ExtractGroupFromAddress(isReadOnly ?
                    address.Replace("/avatar/parameters/", "/avatar/parameters/VRChat/") :
                    address);

                if (!groups.ContainsKey(group))
                    groups[group] = new List<JToken>();

                groups[group].Add(param);
            }

            var sb = new StringBuilder();
            sb.AppendLine($@"
                <div class='node-group'>
                    <div class='node-group-header'>Event Nodes</div>
                    <div class='node-group-content'>
                        <div class='node-palette-item' draggable='true' data-type='OnStart' data-readonly='false'>OnStart</div>
                        <div class='node-palette-item' draggable='true' data-type='OnParameterChanged' data-readonly='false'>OnParameterChanged</div>
                        <div class='node-palette-item' draggable='true' data-type='OnUpdate' data-readonly='false'>OnUpdate</div>
                        <div class='node-palette-item' draggable='true' data-type='OnVRCNetworkUpdate' data-readonly='false'>OnVRCNetworkUpdate</div>
                    </div>
                </div>
                <div class='node-group'>
                    <div class='node-group-header'>Logic Nodes</div>
                    <div class='node-group-content'>
                        <div class='node-palette-item' draggable='true' data-type='If' data-readonly='false'>If</div>
                        <div class='node-palette-item' draggable='true' data-type='Math' data-readonly='false'>Math</div>
                    </div>
                </div>
                <div class='node-group'>
                    <div class='node-group-header'>Variable Nodes</div>
                    <div class='node-group-content'>
                        <div class='node-palette-item' draggable='true' data-type='VariableGet' data-readonly='false'>Get Variable</div>
                        <div class='node-palette-item' draggable='true' data-type='VariableSet' data-readonly='false'>Set Variable</div>
                    </div>
                </div>
                <div class='node-group'>
                    <div class='node-group-header'>Constants</div>
                    <div class='node-group-content'>
                        <div class='node-palette-item' draggable='true' data-type='BoolConstant' data-readonly='false' data-value='false'>Bool Constant</div>
                        <div class='node-palette-item' draggable='true' data-type='FloatConstant' data-readonly='false' data-value='0'>Float Constant</div>
                        <div class='node-palette-item' draggable='true' data-type='IntConstant' data-readonly='false' data-value='0'>Int Constant</div>
                    </div>
                </div>
                <div class='node-group'>
                    <div class='node-group-header'>Avatar Parameters</div>
                    <div class='node-group-content'>");

            // Build HTML for foldout groups
            foreach (var kv in groups.OrderBy(g => g.Key))
            {
                string groupName = kv.Key == "" ? "Ungrouped" : kv.Key;
                sb.AppendLine($@"
                    <div class='node-group'>
                        <div class='node-group-header'>
                            {HtmlEncode(groupName)}
                        </div>
                        <div class='node-group-content'>");

                foreach (var param in kv.Value)
                {
                    var name = param["name"].ToString();
                    var address = param["output"]["address"].ToString();
                    var id = address.Replace("/avatar/parameters/", "");
                    if (id.Contains("/")) id = id.Replace("/", "_");

                    var type = param["output"]["type"].ToString();
                    bool isReadOnly = (vRCDefaultParameters.ContainsKey(id) && vRCDefaultParameters[id] == type)
                                      || param["input"] == null;

                    // Get actual value if present
                    float value = 0f;
                    if (parametersStates.ContainsKey((address, type)))
                        value = parametersStates[(address, type)];

                    // Build a draggable node
                    sb.AppendLine($@"
                        <div class='node-palette-item' draggable='true' data-type='{type}' data-id='{id}' data-readonly='{isReadOnly.ToString().ToLower()}' data-value='{value}'>
                            {HtmlEncode(name)} {(isReadOnly ? "(ReadOnly)" : "")}
                            <div id='{id}_minimal_value'>0</div>
                        </div>");
                }

                sb.AppendLine("</div></div>"); // close group content + group div
            }
            sb.AppendLine("</div></div>"); // close avatar parameters content
            return sb.ToString();
        }

        // --- UpdateHtml produces a JS fragment which defines window.ParameterList and contains templates for each parameter ---
        private static string UpdateHtml(string oscValue, bool isHost)
        {
            // Locate OSC JSON folder
            var oscFolderPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData) + "Low", "VRChat", "VRChat", "OSC");
            var jsonFilePath = Directory.GetFiles(oscFolderPath, $"{oscValue}.json", SearchOption.AllDirectories).FirstOrDefault();
            if (jsonFilePath == null) { Console.WriteLine("JSON file not found."); return ""; }

            var jsonContent = File.ReadAllText(jsonFilePath);
            var json = JObject.Parse(jsonContent);
            var parameters = json["parameters"];
            var sb = new StringBuilder();

            var normalParams = new List<JToken>();
            var readOnlyParams = new List<JToken>();

            // Pass 1: sort parameters into two categories
            foreach (var param in parameters.Reverse())
            {
                if (param["output"] == null) continue;

                var name = param["name"].ToString();
                var address = param["output"]["address"].ToString();
                var id = address.Replace("/avatar/parameters/", "");
                if (id.Contains("/")) id = id.Replace("/", "_");

                var type = param["output"]["type"].ToString();
                if (IsParameterBlocked(id, type)) continue;

                bool isReadOnly =
                    (vRCDefaultParameters.ContainsKey(id) && vRCDefaultParameters[id] == type)
                    || param["input"] == null;

                if (isReadOnly)
                    readOnlyParams.Add(param);
                else
                    normalParams.Add(param);
            }

            // Merge with read-only parameters last
            var orderedParams = normalParams.Concat(readOnlyParams);

            // Start JS array
            sb.AppendLine("<script>");
            sb.AppendLine("window.ParameterList = window.ParameterList || [];");
            sb.AppendLine("window.ParameterList.length = 0;");

            // Pass 2: build HTML for all params in the new order
            foreach (var param in orderedParams)
            {
                var name = param["name"].ToString();
                var address = param["output"]["address"].ToString();
                var id = address.Replace("/avatar/parameters/", "");
                if (id.Contains("/")) id = id.Replace("/", "_");

                var type = param["output"]["type"].ToString();

                bool isReadOnly =
                    (vRCDefaultParameters.ContainsKey(id) && vRCDefaultParameters[id] == type)
                    || param["input"] == null;

                string group = ExtractGroupFromAddress(isReadOnly ?
                    param["output"]["address"].ToString().Replace("/avatar/parameters/", "/avatar/parameters/VRChat/") :
                    param["output"]["address"].ToString());

                if (!lockStates.ContainsKey((address, type))) lockStates.Add((address, type), false);
                if (!parametersStates.ContainsKey((address, type))) parametersStates.Add((address, type), 0f);

                string lockClass = lockStates[(address, type)] ? "locked" : "";

                string html = type switch
                {
                    "Bool" => CreateBoolControl(id, name, address, lockClass, isHost, parametersStates[(address, type)] == 1 ? "on" : "off", isReadOnly),
                    "Float" => CreateFloatControl(id, name, address, lockClass, isHost, parametersStates[(address, type)], isReadOnly),
                    "Int" => CreateIntControl(id, name, address, lockClass, isHost, parametersStates[(address, type)], isReadOnly),
                    _ => CreateUnknownControl(id, name, address, type, lockClass)
                };

                var jsHtml = EscapeForJs(html);

                sb.AppendLine($@"window.ParameterList.push({{
            id: '{JsEncode(id)}',
            name: '{JsEncode(name)}',
            type: '{JsEncode(type)}',
            group: '{JsEncode(group)}',
            html: `{jsHtml}`
        }});");
            }

            sb.AppendLine("</script>");
            return sb.ToString();
        }

        private static string ExtractGroupFromAddress(string address)
        {
            var key = "/avatar/parameters/";
            if (!address.StartsWith(key)) return "";
            var remainder = address.Substring(key.Length).Trim('/');
            if (!remainder.Contains("/")) return ""; // no group path
            var parts = remainder.Split('/');
            // drop last segment (param name), return joined path (can include "groups/..." etc)
            var groupParts = parts.Take(parts.Length - 1);
            return string.Join("/", groupParts);
        }
        private static string CreateBoolControl(string id, string name, string reff, string lockClass, bool isHost, string v, bool isReadOnly) => $@"
    <div class=""parameter-container"">
        <div class=""param-header"">{HtmlEncode(name)}</div>
        <button id=""{HtmlEncode(id)}"" 
                class=""bool-button {v}"" 
                {(isReadOnly ? "disabled" : $@"onclick=""toggleBool('{HtmlEncode(reff)}', this)""")}>
            OFF
        </button>
        {(isHost && !isReadOnly ?
            $@"<button id=""lock-{HtmlEncode(id)}"" class=""lock-button {lockClass}"" onclick=""toggleLock('{HtmlEncode(reff)}','Bool', this)"">Lock</button>"
            : "")}
    </div>";
        private static string CreateFloatControl(string id, string name, string reff, string lockClass, bool isHost, float v, bool isReadOnly) => $@"
    <div class=""parameter-container"">
        <div class=""param-header"">{HtmlEncode(name)}</div>
        <input id=""input-{HtmlEncode(id)}"" 
               class=""value-input"" 
               type=""number"" 
               step=""0.01"" 
               value=""{v}""
               {(isReadOnly ? "disabled" : $@"oninput=""updateValueDisplay('{HtmlEncode(id)}', this.value); sendOsc('{HtmlEncode(reff)}', this.value, 'Float')""")}>
        {(isHost && !isReadOnly ?
            $@"<button id=""lock-{HtmlEncode(id)}"" class=""lock-button {lockClass}"" onclick=""toggleLock('{HtmlEncode(reff)}','Float', this)"">Lock</button>"
            : "")}
    </div>";
        private static string CreateIntControl(string id, string name, string reff, string lockClass, bool isHost, float v, bool isReadOnly) => $@"
            <div class=""parameter-container"">
                <div class=""param-header"">{HtmlEncode(name)}</div>
                <input id=""input-{HtmlEncode(id)}"" 
                       class=""value-input"" 
                       type=""number"" 
                       step=""1"" 
                       value=""{v}""
                       {(isReadOnly ? "disabled" : $@"oninput=""updateValueDisplay('{HtmlEncode(id)}', this.value); sendOsc('{HtmlEncode(reff)}', this.value, 'Int')""")}>
                {(isHost && !isReadOnly ?
                    $@"<button id=""lock-{HtmlEncode(id)}"" class=""lock-button {lockClass}"" onclick=""toggleLock('{HtmlEncode(reff)}','Int', this)"">Lock</button>"
                    : "")}
            </div>";

        private static string CreateUnknownControl(string id, string name, string reff, string type, string lockClass) => $@"
            <div class=""parameter-container"">
                <div class=""param-header"">{HtmlEncode(name)} <small>({HtmlEncode(type)})</small></div>
                <div style=""padding:6px;"">Unsupported parameter type: {HtmlEncode(type)}</div>
            </div>";
        private static string EscapeForJs(string html)
        {
            // backticks need escaping because we use template literals; also escape ${ to avoid interpolation
            return html.Replace("\\", "\\\\").Replace("`", "\\`").Replace("${", "\\${");
        }
        private static string JsEncode(string s)
        {
            if (s == null) return "";
            return s.Replace("\\", "\\\\").Replace("'", "\\'").Replace("\"", "\\\"").Replace("\r", "").Replace("\n", " ");
        }
        private static string HtmlEncode(string s) { if (s == null) return ""; return System.Net.WebUtility.HtmlEncode(s); }

        private static string GenerateSaveLoadButtonsHtml()
        {
            var sb = new StringBuilder();
            for (int i = 0; i < saveCount; i++)
            {
                sb.AppendLine($@"<div class=""button-container""><button onclick=""saveState({i})"">Save Slot #{i}</button>
                                 <button onclick=""loadState({i})"">Load Slot #{i}</button></div>");
            }
            return sb.ToString();
        }
        private static bool IsParameterBlocked(string id, string type)
        {
            string globalFile = "parameters/avatar_Global_settings.json";
            string avatarFile = $"parameters/avatar_{CurrentID}_settings.json";

            if (File.Exists(globalFile) && IsBlocked(LoadSettings(globalFile), id, type)) return true;
            if (File.Exists(avatarFile) && IsBlocked(LoadSettings(avatarFile), id, type)) return true;

            return false;
        }
        public static ParameterSettings LoadSettings(string filePath)
        {
            if (File.Exists(filePath))
            {
                return JsonConvert.DeserializeObject<ParameterSettings>(File.ReadAllText(filePath));
            }
            return new ParameterSettings();
        }
        public static bool IsBlocked(ParameterSettings settings, string id, string type)
        {
            List<string> blockList = new List<string>();
            string mode = string.Empty;

            if (type == "Bool")
            {
                blockList = GetParameterNamesByType(settings, "Bool");
                mode = settings.BoolMode;
            }
            else if (type == "Float")
            {
                blockList = GetParameterNamesByType(settings, "Float");
                mode = settings.FloatMode;
            }
            else if (type == "Int")
            {
                blockList = GetParameterNamesByType(settings, "Int");
                mode = settings.IntMode;
            }

            // Wildcard matching and checking block/whitelist mode
            foreach (var item in blockList)
            {
                if (WildcardMatch(id, item.Replace("/avatar/parameters/", "")))
                {
                    return true;  // Return true if blocked by blacklist
                }
            }

            return false; // Not blocked
        }
        public static List<string> GetParameterNamesByType(ParameterSettings settings, string type)
        {
            List<string> result = new List<string>();
            foreach (var param in settings.Parameters)
            {
                if (param.Type.Equals(type, StringComparison.OrdinalIgnoreCase))
                {
                    result.Add(param.Name);
                }
            }
            return result;
        }
        public static bool WildcardMatch(string input, string pattern)
        {
            // Convert wildcard pattern to regex pattern
            string regexPattern = "^" + Regex.Escape(pattern).Replace("\\*", ".*") + "$";
            return Regex.IsMatch(input, regexPattern);
        }

        #endregion

        #region Argument Parsing
        private static void ParseArguments(string[] args)
        {
            string lastArg = "";
            foreach (var arg in args)
            {
                if (lastArg.StartsWith("-"))
                {
                    switch (lastArg)
                    {
                        case "-WebPort": webPort = int.Parse(arg); break;
                        case "-OSCPortOUT": oscPortOut = int.Parse(arg); break;
                        case "-OSCPortIN": oscPortIn = int.Parse(arg); break;
                        case "-DNS": DNS = arg; break;
                        case "-slot": saveCount = int.Parse(arg); break;
                        case "-logger": logger = bool.Parse(arg); break;
                        case "-usehttps": UseHTTPS = true; httpsTXTReplace = "https://"; wsTXTReplace = "wss://"; break;
                    }
                }
                lastArg = arg;
            }
        }
        #endregion
    }

    #region WebSocket Handler

    public class WebSocketHandler
    {
        private static readonly List<WebSocket> _webSockets = new List<WebSocket>();
        private readonly WebSocket _webSocket;

        public WebSocketHandler(WebSocket webSocket)
        {
            _webSocket = webSocket;
            lock (_webSockets) { _webSockets.Add(webSocket); }
        }

        public async Task HandleAsync()
        {
            var buffer = new byte[1024 * 8];
            WebSocketReceiveResult result = null;

            try
            {
                do
                {
                    result = await _webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
                    if (result.MessageType == WebSocketMessageType.Text)
                    {
                        var msg = Encoding.UTF8.GetString(buffer, 0, result.Count);
                        ProcessMessage(msg);
                    }
                } while (!result.CloseStatus.HasValue);
            }
            finally
            {
                lock (_webSockets) { _webSockets.Remove(_webSocket); }
                if (_webSocket.State != WebSocketState.Closed)
                    await _webSocket.CloseAsync(result?.CloseStatus ?? WebSocketCloseStatus.NormalClosure, "Closing", CancellationToken.None);
            }
        }

        private static void ProcessMessage(string json)
        {
            try
            {
                var jObj = JObject.Parse(json);
                var action = jObj["action"]?.ToString();

                switch (action)
                {
                    case "nothing":
                        break;
                    default:
                        Console.WriteLine("Unknown action: " + action);
                        break;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error processing WebSocket message: " + ex);
            }
        }
        public static async Task BroadcastMessage(string message)
        {
            var buffer = Encoding.UTF8.GetBytes(message);
            var segment = new ArraySegment<byte>(buffer);

            List<WebSocket> disconnected = new();

            foreach (var ws in _webSockets)
            {
                if (ws.State == WebSocketState.Open)
                    await ws.SendAsync(segment, WebSocketMessageType.Text, true, CancellationToken.None);
                else
                    disconnected.Add(ws);
            }

            foreach (var ws in disconnected)
                _webSockets.Remove(ws);
        }
    }
    #endregion

    #region Data Models
    public class State { public List<Toggle> Toggles { get; set; } public List<Slider> Sliders { get; set; } }
    public class Toggle { public string Id { get; set; } public bool Checked { get; set; } }
    public class Slider { public string Id { get; set; } public float Value { get; set; } public string Type { get; set; } }
    public class AvatarList { public string[] AvatarIds { get; set; } public bool IsWhiteList { get; set; } }
    public class Parameter { public string Name { get; set; } public string Type { get; set; } }
    public class ParameterSettings { public List<Parameter> Parameters { get; set; } public string BoolMode { get; set; } public string IntMode { get; set; } public string FloatMode { get; set; } }
    public class UdpRoute { public string InputPort { get; set; } public List<UdpOutput> Outputs { get; set; } }
    public class UdpOutput { public string Ip { get; set; } public string Port { get; set; } }
    public class RoutingConfiguration { public int InputPort { get; set; } public List<Output> Outputs { get; set; } }
    public class Output { public string Ip { get; set; } public int Port { get; set; } }

    #endregion
}

